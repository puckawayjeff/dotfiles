# Custom Last Login Display - Implementation Summary

## Overview

Successfully implemented a custom last login display system that replaces PAM's default `pam_lastlog` message with a styled, feature-rich alternative.

## What Was Created

### 1. Core Script: `lib/last-login.sh`

**Features:**
- **IP-to-Hostname Mapping**: Configurable lookup table to resolve known IPs to friendly names
- **Styled Output**: Uses colors from `lib/utils.sh` (green, cyan, yellow)
- **Cleaner Timestamps**: Formats dates as "Thu Dec 4, 2025 at 1:43 PM"
- **Multiple Data Sources**: Reads from both `last` (wtmp) and `lastlog` for reliability
- **Smart Detection**: Only displays during SSH sessions (`$SSH_CONNECTION`)
- **Fallback Support**: Shows IP address if hostname not in mapping table

**Example Output:**
```bash
# With hostname mapping
Last login: from krang on Thu Dec 4, 2025 at 1:43 PM

# Without mapping (fallback to IP)
Last login: from 100.100.166.103 on Thu Dec 4, 2025 at 1:43 PM

# Local login
Last login: locally on Thu Dec 4, 2025 at 1:43 PM
```

### 2. Terminal.sh Integration: `lib/terminal.sh`

**Purpose:** Automatically configures SSH to disable default lastlog during initial setup

**Function:** `configure_last_login()`

**What it does:**
- Creates backup of `/etc/ssh/sshd_config` (`.dotfiles-backup` suffix)
- Sets `PrintLastLog no` in SSH configuration
- Handles all scenarios: commented, yes, no, or missing directive
- Restarts SSH service to apply changes
- Integrated into main terminal setup workflow
- Runs automatically during `join.sh` deployment

**Manual Usage:**
```bash
sudo ~/dotfiles/lib/terminal.sh
```

### 3. Shell Integration: `.zshrc`

Added automatic sourcing of `lib/last-login.sh` during SSH sessions:

```bash
# ===== Custom Last Login Display =====
# Show custom last login message for SSH sessions (replaces PAM lastlog)
if [[ -n "$SSH_CONNECTION" ]] && [[ -f "$HOME/dotfiles/lib/last-login.sh" ]]; then
    source "$HOME/dotfiles/lib/last-login.sh"
fi
```

### 4. Documentation

**Added/Updated:**
- `docs/Setup Scripts Reference.md` - Complete setup instructions and usage guide
- `docs/Functions Reference.md` - New "Library Scripts" section with detailed reference
- `CHANGELOG.md` - Entry in "Unreleased" section documenting the feature

## How to Use

### Initial Setup

1. **Automatic configuration** during initial deployment:
   - `join.sh` automatically runs `lib/terminal.sh` which configures last-login
   - No manual intervention needed for new hosts

2. **Manual configuration** (if needed):
   ```bash
   sudo ~/dotfiles/lib/terminal.sh
   ```

3. **Configure IP mappings** (optional):
   Edit `lib/last-login.sh` and add your hosts to the `IP_HOSTNAMES` array:
   ```bash
   declare -A IP_HOSTNAMES=(
       ["100.100.166.103"]="krang"
       ["192.168.1.100"]="server1"
       ["10.0.0.50"]="workstation"
   )
   ```

4. **Test the display**:
   ```bash
   SSH_CONNECTION='test' bash ~/dotfiles/lib/last-login.sh
   ```

5. **Deploy to existing hosts**:
   ```bash
   dotpush "Add custom last-login display as core feature"
   ```
   
   Then on each existing host:
   ```bash
   dotpull
   sudo ~/dotfiles/lib/terminal.sh  # Re-runs terminal setup including last-login config
   ```

### Customization

**Add IP-to-Hostname Mappings:**

Edit `~/dotfiles/lib/last-login.sh`:
```bash
declare -A IP_HOSTNAMES=(
    ["100.100.166.103"]="krang"
    # Add more here
)
```

**Change Colors/Styling:**

The script uses variables from `lib/utils.sh`:
- `${GREEN}` - "Last login" text
- `${CYAN}` - Hostname/IP
- `${YELLOW}` - Timestamp
- `${NC}` - Reset color

**Modify Date Format:**

Edit the `format_timestamp()` function in `lib/last-login.sh`:
```bash
date -d "$timestamp" "+%a %b %-d, %Y at %-I:%M %p"
```

### Reverting to Default

If you want to restore PAM's original lastlog:

```bash
# Option 1: Restore from backup
sudo cp /etc/pam.d/sshd.dotfiles-backup /etc/pam.d/sshd

# Option 2: Manually edit
sudo nano /etc/pam.d/sshd
# Uncomment the pam_lastlog.so line
```

## Technical Details

### How SSH Lastlog Works

The default "Last login" message is generated by OpenSSH's `sshd` daemon, controlled by the `PrintLastLog` directive in `/etc/ssh/sshd_config`. When enabled (the default), it reads from the system's lastlog database and prints the information before the user's shell starts.

**Default SSH configuration:**
```
#PrintLastLog yes  # (commented = enabled by default)
```

### Our Implementation

Instead of using SSH's built-in lastlog, we:
1. Disable SSH's `PrintLastLog` (set to `no` in `/etc/ssh/sshd_config`)
2. Source our custom script from `.zshrc` when `$SSH_CONNECTION` is set
3. Query login history using `last` and `lastlog` commands
4. Format and display using our styled output

**Advantages:**
- Full control over formatting and styling
- Can add custom features (IP mapping, better timestamps)
- Easy to modify without touching system files
- Portable across hosts via dotfiles sync
- Consistent with our other styled output

## Files Modified

- ✅ `lib/last-login.sh` (created) - Display script with IP mapping
- ✅ `lib/terminal.sh` (modified) - Added `configure_last_login()` function
- ✅ `config/.zshrc` (modified) - Auto-sources last-login.sh on SSH
- ✅ `docs/Setup Scripts Reference.md` (modified) - Updated documentation
- ✅ `docs/Functions Reference.md` (modified) - Added library script reference
- ✅ `docs/Custom Last Login Implementation.md` (modified) - Implementation guide
- ✅ `CHANGELOG.md` (modified) - Documented as core feature

## Next Steps

1. **Test on a remote host**: SSH into another machine to verify the display
2. **Add your IP mappings**: Populate the `IP_HOSTNAMES` array with your known hosts
3. **Deploy to other hosts**: Use `dotpush` and `dotpull` to sync across machines
4. **Run setup script**: Execute `sudo setup/last-login.sh` on each host

## Notes

- The script only displays during SSH sessions (checks `$SSH_CONNECTION`)
- Falls back gracefully if `last` command fails (uses `lastlog`)
- Handles cases where there's no login history
- Works with both local and remote logins
- Compatible with Debian-based systems (tested on Ubuntu/Debian)
