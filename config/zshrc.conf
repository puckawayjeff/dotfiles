# ~/.zshrc - Zsh configuration with Zinit plugin manager
# Optimized for speed and power-user features

# ===== Early Setup =====
# Skip all this for non-interactive shells
[[ $- != *i* ]] && return

# ===== History Configuration =====
HISTFILE=~/.zsh_history
HISTSIZE=10000
SAVEHIST=10000
setopt EXTENDED_HISTORY          # Write timestamps to history
setopt HIST_EXPIRE_DUPS_FIRST    # Expire duplicates first when trimming
setopt HIST_IGNORE_DUPS          # Don't record duplicate entries
setopt HIST_IGNORE_SPACE         # Don't record entries starting with space
setopt HIST_VERIFY               # Don't execute immediately upon history expansion
setopt SHARE_HISTORY             # Share history between all sessions

# ===== Directory Navigation =====
setopt AUTO_CD                   # Type directory name to cd
setopt AUTO_PUSHD                # Push directories onto stack
setopt PUSHD_IGNORE_DUPS         # Don't push duplicates
setopt PUSHD_SILENT              # Don't print directory stack

# ===== Completion System =====
setopt COMPLETE_IN_WORD          # Complete from cursor position
setopt ALWAYS_TO_END             # Move cursor to end after completion
setopt AUTO_MENU                 # Show completion menu on tab
setopt AUTO_LIST                 # List choices on ambiguous completion

# ===== Completion System =====
setopt INTERACTIVE_COMMENTS      # Safely ignore pasted comment lines in the terminal


# ===== Zinit Installation and Setup =====
ZINIT_HOME="${XDG_DATA_HOME:-${HOME}/.local/share}/zinit/zinit.git"

# Install zinit if not present
if [[ ! -d "$ZINIT_HOME" ]]; then
    # Source utils for consistent logging
    if [[ -f "$HOME/dotfiles/lib/utils.sh" ]]; then
        source "$HOME/dotfiles/lib/utils.sh"
        log_action "Installing Zinit plugin manager..." "$PACKAGE"
    else
        print -P "%F{33}Installing Zinit plugin manager...%f"
    fi
    
    command mkdir -p "$(dirname $ZINIT_HOME)"
    if command git clone https://github.com/zdharma-continuum/zinit.git "$ZINIT_HOME" 2>/dev/null; then
        [[ -n "$log_success" ]] && log_success "Zinit installed successfully" || print -P "%F{34}Installation successful.%f"
    else
        [[ -n "$log_error" ]] && log_error "Zinit installation failed" || print -P "%F{160}Installation failed.%f"
    fi
fi

# Load zinit
source "${ZINIT_HOME}/zinit.zsh"

# ===== Zinit Plugins =====

# 1. zsh-completions - Additional completion definitions (load early)
zinit ice wait lucid blockf atpull'zinit creinstall -q .'
zinit light zsh-users/zsh-completions

# 2. zsh-autosuggestions - Fish-like autosuggestions
zinit ice wait lucid atload'_zsh_autosuggest_start'
zinit light zsh-users/zsh-autosuggestions
ZSH_AUTOSUGGEST_STRATEGY=(history completion)
ZSH_AUTOSUGGEST_BUFFER_MAX_SIZE=20
# Bind Ctrl+Space to accept autosuggestion
bindkey '^@' autosuggest-accept

# 3. zsh-history-substring-search - MUST load before syntax-highlighting
zinit ice wait lucid atload'
    bindkey "^[[A" history-substring-search-up
    bindkey "^[[B" history-substring-search-down
    bindkey -M emacs "^P" history-substring-search-up
    bindkey -M emacs "^N" history-substring-search-down
'
zinit light zsh-users/zsh-history-substring-search

# 3b. zsh-thefuck - DISABLED (incompatible with Python 3.13+)
# TheFuck requires Python distutils and imp modules removed in 3.13
# Awaiting upstream fix: https://github.com/nvbn/thefuck/issues/1495
# zinit ice wait lucid
# zinit light laggardkernel/zsh-thefuck

# 4. Fast-syntax-highlighting - MUST load LAST (after other ZLE widgets)
zinit ice wait lucid
zinit light zdharma-continuum/fast-syntax-highlighting

# ===== Oh-My-Zsh Plugin Snippets =====
# Load select oh-my-zsh plugins via Zinit

# 5. git - Essential git aliases and functions
zinit snippet OMZ::plugins/git/git.plugin.zsh

# 6. docker - Docker completion and aliases
zinit snippet OMZ::plugins/docker/docker.plugin.zsh

# 7. extract - Universal archive extraction (replaces unpackk)
zinit snippet OMZ::plugins/extract/extract.plugin.zsh

# 9. command-not-found - Suggests packages for missing commands
zinit snippet OMZ::plugins/command-not-found/command-not-found.plugin.zsh

# Override command_not_found_handler to add dothelp reminder
command_not_found_handler() {
    # First, try the system command-not-found (if available)
    if [[ -x /usr/lib/command-not-found ]]; then
        /usr/lib/command-not-found -- "$1"
        local exit_code=$?
    elif [[ -x /usr/share/command-not-found/command-not-found ]]; then
        /usr/share/command-not-found/command-not-found -- "$1"
        local exit_code=$?
    else
        printf "zsh: command not found: %s\n" "$1" >&2
        local exit_code=127
    fi
    
    # Add helpful reminder about dothelp
    printf "\n${CYAN}ðŸ’¡ Tip:${NC} Type ${YELLOW}dothelp${NC} to see all available commands\n" >&2
    
    return $exit_code
}

# 10. colored-man-pages - Syntax highlighted man pages
zinit snippet OMZ::plugins/colored-man-pages/colored-man-pages.plugin.zsh

# 11. copypath - Copy current directory path to clipboard
zinit snippet OMZ::plugins/copypath/copypath.plugin.zsh

# 12. copyfile - Copy file contents to clipboard
zinit snippet OMZ::plugins/copyfile/copyfile.plugin.zsh

# ===== Additional Plugins =====

# 13. zsh-help - Colorize --help output with bat
zinit ice wait lucid
zinit light Freed-Wu/zsh-help

# 14. printdocker-zsh-plugin - Pretty print Docker objects
zinit ice wait lucid
zinit light elvitin/printdocker-zsh-plugin

# 15. zsh-sshinfo - Display SSH connection info before connecting
# DISABLED: Box-drawing characters render incorrectly
# zinit ice wait lucid
# zinit light SckyzO/zsh-sshinfo

# 16. zsh-activate-py-environment - Auto-activate Python environments
zinit ice wait lucid
zinit light se-jaeger/zsh-activate-py-environment

# Initialize completion system
autoload -Uz compinit
# Only regenerate .zcompdump once a day
if [[ -n ${ZDOTDIR}/.zcompdump(#qN.mh+24) ]]; then
    compinit
else
    compinit -C
fi

# ===== Completion Styling =====
zstyle ':completion:*' matcher-list 'm:{a-z}={A-Za-z}'  # Case insensitive
zstyle ':completion:*' list-colors "${(s.:.)LS_COLORS}"  # Colored completion
zstyle ':completion:*' menu select                       # Menu-driven completion
zstyle ':completion:*' group-name ''                     # Group completions
zstyle ':completion:*:descriptions' format '%F{yellow}-- %d --%f'
zstyle ':completion:*:warnings' format '%F{red}-- no matches found --%f'

# ===== SSH Completion =====
# Enable completion from ~/.ssh/config and ~/.ssh/known_hosts
zstyle ':completion:*:ssh:*' hosts off  # Don't use system hosts
zstyle ':completion:*:ssh:*' users off  # Don't complete usernames

# Custom SSH host completion function
function _ssh_hosts() {
    local -a ssh_hosts
    
    # Read from ~/.ssh/config
    if [[ -f ~/.ssh/config ]]; then
        ssh_hosts+=(${${${${(@M)${(f)"$(<~/.ssh/config)"}:#Host *}#Host }:#*[*?]*}:#*/*})
    fi
    
    # Read from sshsync ssh.conf if it exists (enhanced mode)
    if [[ -f ~/sshsync/ssh.conf ]]; then
        ssh_hosts+=(${${${${(@M)${(f)"$(<~/sshsync/ssh.conf)"}:#Host *}#Host }:#*[*?]*}:#*/*})
    fi
    
    # Remove duplicates and provide to completion
    _describe 'ssh hosts' ssh_hosts
}

# Register the completion function for ssh, scp, sftp
compdef _ssh_hosts ssh
compdef _ssh_hosts scp
compdef _ssh_hosts sftp

# ===== Color Support =====
export GCC_COLORS='error=01;31:warning=01;35:note=01;36:caret=01;32:locus=01:quote=01'

# ===== Aliases =====
# Standard aliases
alias grep='grep --color=auto'
alias fgrep='fgrep --color=auto'
alias egrep='egrep --color=auto'
alias bat='batcat --color=auto'

# ls/eza aliases (conditional on eza installation)
if command -v eza >/dev/null 2>&1; then
    # Set eza theme directory
    export EZA_CONFIG_DIR="$HOME/.config/eza"
    
    alias ls='eza --color=auto --group-directories-first'
    alias ll='eza --icons -lag --group-directories-first --git'
    alias la='eza --icons -a --group-directories-first'
    alias l='eza --icons -1 --group-directories-first'
    alias lt='eza --icons --tree --level=2 --group-directories-first'
else
    alias ll='ls -alh'
    alias la='ls -A'
    alias l='ls -CF'
fi

# Python environment shortcuts
alias link-pyenv='link_py_environment'
alias unlink-pyenv='unlink_py_environment'

# Load additional aliases if present
[[ -f ~/.zsh_aliases ]] && source ~/.zsh_aliases

# ===== Fastfetch Integration =====
# Note: Fastfetch runs automatically via MOTD on login (see lib/motd.sh)
# Aliases provided for manual invocation
if command -v fastfetch >/dev/null 2>&1; then
    alias neofetch="fastfetch -c neofetch"
    alias screenfetch="fastfetch -c screenfetch"
    alias ff="fastfetch"  # Quick manual invocation
fi

# ===== Tool Integrations =====

# User Binaries
if [[ -d "$HOME/bin" ]]; then
    export PATH="$HOME/bin:$PATH"
fi

if [[ -d "$HOME/.local/bin" ]]; then
    export PATH="$HOME/.local/bin:$PATH"
fi

# Deno
if [[ -d "$HOME/.deno" ]]; then
    export DENO_INSTALL="$HOME/.deno"
    export PATH="$DENO_INSTALL/bin:$PATH"
fi

# .NET
if [[ -d "$HOME/.dotnet" ]]; then
    export DOTNET_ROOT="$HOME/.dotnet"
    export PATH="$PATH:$DOTNET_ROOT"
fi

# NVM (Node Version Manager)
export NVM_DIR="$HOME/.nvm"
[[ -s "$NVM_DIR/nvm.sh" ]] && source "$NVM_DIR/nvm.sh"
[[ -s "$NVM_DIR/bash_completion" ]] && source "$NVM_DIR/bash_completion"

# FZF (Fuzzy Finder)
if command -v fzf >/dev/null 2>&1; then
    # Set up fzf key bindings and fuzzy completion
    if [[ -f /usr/share/doc/fzf/examples/key-bindings.zsh ]]; then
        source /usr/share/doc/fzf/examples/key-bindings.zsh
    fi
    if [[ -f /usr/share/doc/fzf/examples/completion.zsh ]]; then
        source /usr/share/doc/fzf/examples/completion.zsh
    fi
    
    # FZF configuration
    export FZF_DEFAULT_OPTS='
        --height 40% 
        --layout=reverse 
        --border 
        --inline-info
        --color=fg:#d8d8d8,bg:#181818,hl:#bd93f9
        --color=fg+:#f8f8f2,bg+:#282828,hl+:#ff79c6
        --color=info:#8be9fd,prompt:#50fa7b,pointer:#ff79c6
        --color=marker:#50fa7b,spinner:#8be9fd,header:#6272a4'
    
    # Use fd if available for faster file finding
    if command -v fd >/dev/null 2>&1; then
        export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --exclude .git'
        export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
    fi
fi

# Zoxide (smart cd - use 'z' command)
# Rename to avoid 'zi' alias conflict with Zinit
if command -v zoxide >/dev/null 2>&1; then
    eval "$(zoxide init --cmd j zsh)"
fi

# Direnv (auto-load directory environments)
if command -v direnv >/dev/null 2>&1; then
    eval "$(direnv hook zsh)"
fi

# Starship prompt
if command -v starship >/dev/null 2>&1; then
    eval "$(starship init zsh)"
fi

# ===== Custom Functions =====
# Load functions from separate file
if [[ -f ~/.zsh_functions ]]; then
    source ~/.zsh_functions
fi

# ===== Performance Optimization =====
# Compile zcompdump for faster startup
{
    zcompdump="${ZDOTDIR:-$HOME}/.zcompdump"
    if [[ -s "$zcompdump" && (! -s "${zcompdump}.zwc" || "$zcompdump" -nt "${zcompdump}.zwc") ]]; then
        zcompile "$zcompdump"
    fi
} &!

# ===== End of Configuration =====
