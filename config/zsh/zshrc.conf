# ~/.zshrc - Puckadots v3.0 Main Config
# Modular configuration loader

# ===== Early Checks =====
[[ $- != *i* ]] && return

# ===== Define Paths =====
export DOTFILES_DIR="${HOME}/dotfiles"
export ZSH_CONFIG_DIR="${DOTFILES_DIR}/config/zsh"

# ===== Load Modules =====
# Order matters: Options -> Exports -> Init (plugins) -> Completion -> Aliases -> Functions

source "${ZSH_CONFIG_DIR}/options.zsh"
source "${ZSH_CONFIG_DIR}/exports.zsh"
source "${ZSH_CONFIG_DIR}/init.zsh"
source "${ZSH_CONFIG_DIR}/completion.zsh"
source "${ZSH_CONFIG_DIR}/aliases.zsh"

# ===== Load Functions =====
# Sourced from symlink location for consistency
if [[ -f ~/.zsh_functions ]]; then
    source ~/.zsh_functions
fi

# ===== Local Overrides =====
if [[ -f ~/.zsh_aliases ]]; then
    source ~/.zsh_aliases
fi

# ===== Integrations =====

# FZF
if command -v fzf >/dev/null 2>&1; then
    if [[ -f /usr/share/doc/fzf/examples/key-bindings.zsh ]]; then
        source /usr/share/doc/fzf/examples/key-bindings.zsh
    fi
    if [[ -f /usr/share/doc/fzf/examples/completion.zsh ]]; then
        source /usr/share/doc/fzf/examples/completion.zsh
    fi
    
    export FZF_DEFAULT_OPTS='
        --height 40% 
        --layout=reverse 
        --border 
        --inline-info
        --preview-window=right:60%
        --color=fg:#d8d8d8,bg:#181818,hl:#bd93f9
        --color=fg+:#f8f8f2,bg+:#282828,hl+:#ff79c6
        --color=info:#8be9fd,prompt:#50fa7b,pointer:#ff79c6
        --color=marker:#50fa7b,spinner:#8be9fd,header:#6272a4'
    
    if command -v fd >/dev/null 2>&1; then
        export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --exclude .git'
        export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
        export FZF_ALT_C_COMMAND='fd --type d --hidden --exclude .git'
        export FZF_ALT_C_OPTS="--preview 'eza --tree --level=2 --color=always {} 2>/dev/null || ls -la {}'"
    fi
fi

# Zoxide
if command -v zoxide >/dev/null 2>&1; then
    eval "$(zoxide init --cmd j zsh)"
fi

# Direnv
if command -v direnv >/dev/null 2>&1; then
    eval "$(direnv hook zsh)"
fi

# Starship
if command -v starship >/dev/null 2>&1; then
    eval "$(starship init zsh)"
fi

# Performance Optimization (zcompdump)
{
    zcompdump="${ZDOTDIR:-$HOME}/.zcompdump"
    if [[ -s "$zcompdump" && (! -s "${zcompdump}.zwc" || "$zcompdump" -nt "${zcompdump}.zwc") ]]; then
        zcompile "$zcompdump"
    fi
} &!
